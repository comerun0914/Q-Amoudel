import{f as o,A as Le,u as Pe,O as qe,r as u,l as S,i as Me,n as Ue,c as d,o as i,d as g,e as s,w as l,g as _,t as c,h as O,k as T,M as $e,q as N,C,m as E,T as K,L as ee,N as Qe,p as L,F as M,H as V,V as Re}from"./index-90a1d7b0.js";import{_ as Be}from"./_plugin-vue_export-helper-c27b6911.js";import{S as Fe}from"./SaveOutlined-03c9a56b.js";var Ve={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"defs",attrs:{},children:[{tag:"style",attrs:{}}]},{tag:"path",attrs:{d:"M931.4 498.9L94.9 79.5c-3.4-1.7-7.3-2.1-11-1.2a15.99 15.99 0 00-11.7 19.3l86.2 352.2c1.3 5.3 5.2 9.6 10.4 11.3l147.7 50.7-147.6 50.7c-5.2 1.8-9.1 6-10.3 11.3L72.2 926.5c-.9 3.7-.5 7.6 1.2 10.9 3.9 7.9 13.5 11.1 21.5 7.2l836.5-417c3.1-1.5 5.6-4.1 7.2-7.1 3.9-8 .7-17.6-7.2-21.6zM170.8 826.3l50.3-205.6 295.2-101.3c2.3-.8 4.2-2.6 5-5 1.4-4.2-.8-8.7-5-10.2L221.1 403 171 198.2l628 314.9-628.2 313.2z"}}]},name:"send",theme:"outlined"};const ze=Ve;function te(k){for(var m=1;m<arguments.length;m++){var v=arguments[m]!=null?Object(arguments[m]):{},x=Object.keys(v);typeof Object.getOwnPropertySymbols=="function"&&(x=x.concat(Object.getOwnPropertySymbols(v).filter(function(I){return Object.getOwnPropertyDescriptor(v,I).enumerable}))),x.forEach(function(I){je(k,I,v[I])})}return k}function je(k,m,v){return m in k?Object.defineProperty(k,m,{value:v,enumerable:!0,configurable:!0,writable:!0}):k[m]=v,k}var z=function(m,v){var x=te({},m,v.attrs);return o(Le,te({},x,{icon:ze}),null)};z.displayName="SendOutlined";z.inheritAttrs=!1;const Ge=z;const He={class:"fill-container"},Je={class:"fill-header"},We={class:"header-content"},Xe={class:"header-left"},Ye={class:"progress-info"},Ze={class:"progress-text"},Ke={class:"header-right"},et={class:"timer"},tt={class:"questionnaire-content"},at={class:"questionnaire-title"},nt={class:"questionnaire-meta"},st={class:"meta-item"},ot={class:"meta-item"},lt={key:0,class:"content-wrapper"},rt={key:0,class:"question-container"},it={class:"question-header"},ut={class:"question-title"},ct={class:"question-description"},dt={key:0,class:"question-content"},vt={key:1,class:"question-content"},_t={key:2,class:"question-content"},pt={key:3,class:"question-content"},mt={class:"rating-labels"},ft={key:4,class:"question-content"},gt={class:"navigation-buttons"},wt={key:1,class:"submit-section"},ht={class:"submit-content"},yt={class:"answer-summary"},bt={class:"question-number"},xt={class:"question-text"},kt={class:"answer-text"},It={class:"submit-actions"},St={key:0,class:"error-container"},Ot={__name:"QuestionnaireFill",setup(k){const m=Pe(),v=qe(),x=u(!0),I=u(!1),j=u("无法加载问卷数据"),U=u(!1),$=u(!1),Q=u(!1),G=u("问卷标题"),H=u("问卷描述信息"),J=u("-"),W=u("-"),p=u([]),y=u(0),X=u("00:00"),R=u(Date.now());let P=null;const q=u(!1),ae=u("确认操作"),ne=u("确定要执行此操作吗？"),Y=u(null),n=S(()=>p.value[y.value]||null),se=S(()=>p.value.length===0?"0/0":`${y.value+1}/${p.value.length}`),oe=S(()=>p.value.length===0?0:Math.round((y.value+1)/p.value.length*100)),le=S(()=>p.value.map((a,e)=>{var b,f;let t="未填写";if(a.answer!==void 0&&a.answer!==null&&a.answer!=="")switch(a.type){case"single_choice":const w=(b=a.options)==null?void 0:b.find(h=>h.id===a.answer);t=w?w.text:"已选择";break;case"multiple_choice":if(Array.isArray(a.answer)){const h=(f=a.options)==null?void 0:f.filter(A=>a.answer.includes(A.id));t=(h==null?void 0:h.map(A=>A.text).join(", "))||"已选择"}break;case"text":t=a.answer||"未填写";break;case"rating":t=`${a.answer||0} 分`;break;case"matrix":t="已填写";break}return{index:e,question:a.description,answer:t}})),re=S(()=>!n.value||n.value.type!=="matrix"?[]:[{title:"问题",dataIndex:"text",key:"row",width:"40%"},{title:"选择",key:"answer",width:"60%"}]),ie=S(()=>{var a;return!n.value||n.value.type!=="matrix"?[]:((a=n.value.rows)==null?void 0:a.map(e=>{var t;return{key:e.id,text:e.text,answer:((t=n.value.answer)==null?void 0:t[e.id])||null}}))||[]}),ue=S(()=>{if(!n.value||n.value.type!=="rating")return[];const a=n.value.maxRating||5;return Array.from({length:a},(e,t)=>`${t+1}分`)}),B=S(()=>{if(!n.value||n.value.type!=="rating")return[];const a=n.value.maxRating||5;return Array.from({length:a},(e,t)=>`${t+1}分`)}),ce=()=>{U.value=!0,p.value.some(e=>e.answer!==void 0&&e.answer!==null&&e.answer!=="")?$e.confirm({title:"确认离开",content:"您有未保存的更改，确定要离开吗？",onOk:()=>{m.back()},onCancel:()=>{U.value=!1}}):m.back()},Z=async()=>{var a;x.value=!0,I.value=!1;try{const e=v.params.id,t=v.query.url,b=v.query.code;let f;if(e)f=await N.get(`${C.API_ENDPOINTS.QUESTIONNAIRE_DETAIL}/${e}`);else if(t)f=await N.post(C.API_ENDPOINTS.QUESTIONNAIRE_FILL,{url:t});else if(b)f=await N.post(C.API_ENDPOINTS.QUESTIONNAIRE_FILL,{code:b});else throw new Error("缺少问卷标识");if(f.code===200){const w=f.data;G.value=w.title,H.value=w.description,J.value=new Date(w.createTime).toLocaleString("zh-CN"),W.value=`${w.estimatedTime||10} 分钟`,p.value=((a=w.questions)==null?void 0:a.map(h=>({...h,answer:h.type==="multiple_choice"?[]:null})))||[],await ge(),we()}else throw new Error(f.message||"加载失败")}catch(e){console.error("加载问卷失败:",e),e.value=!0,j.value=e.message||"无法加载问卷数据"}finally{x.value=!1}},de=async()=>{$.value=!0;try{const a=p.value.map(e=>({questionId:e.id,answer:e.answer,type:e.type}));await N.post(C.API_ENDPOINTS.SUBMISSION_SAVE_DRAFT,{questionnaireId:v.params.id,answers:a,timestamp:Date.now()}),E.success("草稿已保存")}catch{E.error("保存草稿失败")}finally{$.value=!1}},ve=()=>{y.value>0&&y.value--},_e=()=>{y.value<p.value.length-1&&y.value++},pe=()=>{y.value=0},me=async()=>{const e=p.value.filter(t=>t.required).filter(t=>t.type==="multiple_choice"?!t.answer||t.answer.length===0:t.answer===void 0||t.answer===null||t.answer==="");if(e.length>0){E.warning(`还有 ${e.length} 道必填题目未完成`);return}Q.value=!0;try{const t=p.value.map(b=>({questionId:b.id,answer:b.answer,type:b.type}));await N.post(C.API_ENDPOINTS.SUBMISSION_SUBMIT,{questionnaireId:v.params.id,answers:t,submitTime:Date.now(),duration:Date.now()-R.value}),E.success("问卷提交成功！"),m.push("/questionnaire/success")}catch{E.error("问卷提交失败，请重试")}finally{Q.value=!1}},fe=()=>{I.value=!1,Z()},ge=async()=>{var a;try{const e=v.params.id;if(!e)return;const t=await N.get(`${C.API_ENDPOINTS.SUBMISSION_GET_DRAFT}?questionnaireId=${e}`);t.code===200&&t.data&&((a=t.data.answers)==null||a.forEach(f=>{const w=p.value.find(h=>h.id===f.questionId);w&&(w.answer=f.answer)}))}catch(e){console.log("加载草稿失败:",e)}},we=()=>{R.value=Date.now(),P=setInterval(()=>{const a=Date.now()-R.value,e=Math.floor(a/6e4),t=Math.floor(a%6e4/1e3);X.value=`${e.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},1e3)},he=()=>{P&&(clearInterval(P),P=null)},ye=()=>{Y.value&&Y.value(),q.value=!1},be=()=>{q.value=!1};return Me(()=>{Z()}),Ue(()=>{he()}),(a,e)=>{const t=d("a-button"),b=d("a-progress"),f=d("a-tag"),w=d("a-radio"),h=d("a-radio-group"),A=d("a-checkbox"),xe=d("a-checkbox-group"),ke=d("a-textarea"),Ie=d("a-rate"),Se=d("a-radio-button"),Oe=d("a-table"),Te=d("a-list-item-meta"),Ne=d("a-list-item"),Ce=d("a-list"),Ae=d("a-spin"),De=d("a-result"),Ee=d("a-modal");return i(),g("div",He,[s("header",Je,[s("div",We,[s("div",Xe,[o(t,{class:"btn-back",onClick:ce,loading:U.value},{icon:l(()=>[o(O(K))]),default:l(()=>[e[5]||(e[5]=_(" 返回 ",-1))]),_:1,__:[5]},8,["loading"]),s("div",Ye,[s("span",Ze,[e[6]||(e[6]=_("进度: ",-1)),s("span",null,c(se.value),1)]),o(b,{percent:oe.value,"show-info":!1,"stroke-color":"#1890ff",class:"progress-bar"},null,8,["percent"])])]),s("div",Ke,[o(t,{class:"btn-save",onClick:de,loading:$.value},{icon:l(()=>[o(O(Fe))]),default:l(()=>[e[7]||(e[7]=_(" 保存草稿 ",-1))]),_:1,__:[7]},8,["loading"]),s("div",et,[o(O(ee)),s("span",null,c(X.value),1)])])])]),s("main",tt,[s("div",at,[s("h1",null,c(G.value),1),s("p",null,c(H.value),1),s("div",nt,[s("span",st,[o(O(Qe)),_(" 开始时间: "+c(J.value),1)]),s("span",ot,[o(O(ee)),_(" 预计用时: "+c(W.value),1)])])]),o(Ae,{spinning:x.value,tip:"正在加载问卷数据..."},{default:l(()=>[!x.value&&!I.value?(i(),g("div",lt,[n.value?(i(),g("div",rt,[s("div",it,[s("h2",ut,[_(" 第"+c(y.value+1)+"题 ",1),n.value.required?(i(),L(f,{key:0,color:"red"},{default:l(()=>e[8]||(e[8]=[_("必填",-1)])),_:1,__:[8]})):T("",!0)]),s("p",ct,c(n.value.description),1)]),n.value.type==="single_choice"?(i(),g("div",dt,[o(h,{value:n.value.answer,"onUpdate:value":e[0]||(e[0]=r=>n.value.answer=r),class:"option-group"},{default:l(()=>[(i(!0),g(M,null,V(n.value.options,r=>(i(),L(w,{key:r.id,value:r.id,class:"option-item"},{default:l(()=>[_(c(r.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])):n.value.type==="multiple_choice"?(i(),g("div",vt,[o(xe,{value:n.value.answer,"onUpdate:value":e[1]||(e[1]=r=>n.value.answer=r),class:"option-group"},{default:l(()=>[(i(!0),g(M,null,V(n.value.options,r=>(i(),L(A,{key:r.id,value:r.id,class:"option-item"},{default:l(()=>[_(c(r.text),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])):n.value.type==="text"?(i(),g("div",_t,[o(ke,{value:n.value.answer,"onUpdate:value":e[2]||(e[2]=r=>n.value.answer=r),rows:4,placeholder:"请输入您的答案...",maxlength:n.value.maxLength||500,"show-count":""},null,8,["value","maxlength"])])):n.value.type==="rating"?(i(),g("div",pt,[o(Ie,{value:n.value.answer,"onUpdate:value":e[3]||(e[3]=r=>n.value.answer=r),count:n.value.maxRating||5,tooltips:ue.value,"show-tooltip":""},null,8,["value","count","tooltips"]),s("div",mt,[s("span",null,c(B.value[0]),1),s("span",null,c(B.value[B.value.length-1]),1)])])):n.value.type==="matrix"?(i(),g("div",ft,[o(Oe,{columns:re.value,"data-source":ie.value,pagination:!1,bordered:!0,size:"small",class:"matrix-table"},{bodyCell:l(({column:r,record:F})=>[r.key==="row"?(i(),g(M,{key:0},[_(c(F.text),1)],64)):(i(),L(h,{key:1,value:F.answer,"onUpdate:value":D=>F.answer=D,size:"small","button-style":"solid"},{default:l(()=>[(i(!0),g(M,null,V(n.value.columns,D=>(i(),L(Se,{key:D.id,value:D.id},{default:l(()=>[_(c(D.text),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["value","onUpdate:value"]))]),_:1},8,["columns","data-source"])])):T("",!0)])):T("",!0),s("div",gt,[o(t,{class:"btn-nav btn-prev",onClick:ve,disabled:y.value===0},{icon:l(()=>[o(O(K))]),default:l(()=>[e[9]||(e[9]=_(" 上一题 ",-1))]),_:1,__:[9]},8,["disabled"]),o(t,{class:"btn-nav btn-next",onClick:_e,disabled:y.value===p.value.length-1},{icon:l(()=>[o(O(Re))]),default:l(()=>[e[10]||(e[10]=_(" 下一题 ",-1))]),_:1,__:[10]},8,["disabled"])]),y.value===p.value.length-1?(i(),g("div",wt,[s("div",ht,[e[13]||(e[13]=s("h3",null,"问卷填写完成",-1)),e[14]||(e[14]=s("p",null,"请检查您的答案，确认无误后点击提交按钮",-1)),s("div",yt,[o(Ce,{"data-source":le.value,size:"small",class:"summary-list"},{renderItem:l(({item:r})=>[o(Ne,null,{default:l(()=>[o(Te,null,{title:l(()=>[s("span",bt,"第"+c(r.index+1)+"题",1),s("span",xt,c(r.question),1)]),description:l(()=>[s("span",kt,c(r.answer),1)]),_:2},1024)]),_:2},1024)]),_:1},8,["data-source"])]),s("div",It,[o(t,{onClick:pe,type:"default"},{default:l(()=>e[11]||(e[11]=[_(" 重新检查 ",-1)])),_:1,__:[11]}),o(t,{onClick:me,type:"primary",loading:Q.value},{icon:l(()=>[o(O(Ge))]),default:l(()=>[e[12]||(e[12]=_(" 提交问卷 ",-1))]),_:1,__:[12]},8,["loading"])])])])):T("",!0)])):T("",!0)]),_:1},8,["spinning"]),I.value?(i(),g("div",St,[o(De,{status:"error",title:"加载失败","sub-title":j.value},{extra:l(()=>[o(t,{type:"primary",onClick:fe},{default:l(()=>e[15]||(e[15]=[_(" 重试 ",-1)])),_:1,__:[15]})]),_:1},8,["sub-title"])])):T("",!0)]),o(Ee,{open:q.value,"onUpdate:open":e[4]||(e[4]=r=>q.value=r),title:ae.value,onOk:ye,onCancel:be},{default:l(()=>[s("p",null,c(ne.value),1)]),_:1},8,["open","title"])])}}},At=Be(Ot,[["__scopeId","data-v-3272737c"]]);export{At as default};
