<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>问卷类型映射修复测试</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/ant-design-vue@4/dist/reset.css">
    <script src="https://unpkg.com/ant-design-vue@4/dist/antd.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 32px;
            padding: 20px;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            background: #fafafa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #1890ff;
            border-bottom: 2px solid #1890ff;
            padding-bottom: 8px;
        }
        .result-box {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            padding: 12px;
            border-radius: 4px;
            margin: 12px 0;
        }
        .error-box {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            padding: 12px;
            border-radius: 4px;
            margin: 12px 0;
        }
        .code-block {
            background: #f5f5f5;
            border: 1px solid #d9d9d9;
            padding: 12px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            margin: 12px 0;
            overflow-x: auto;
        }
        .btn-test {
            margin: 8px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="test-container">
            <h1>问卷类型映射修复测试</h1>
            <p>此页面用于测试问卷类型的中文字符串和数据库tinyint值之间的转换是否正确工作。</p>

            <div class="test-section">
                <h3>1. 问卷类型映射工具测试</h3>
                <p>测试问卷类型映射工具函数是否正常工作：</p>
                
                <a-button type="primary" @click="testMappingFunctions" class="btn-test">
                    测试映射函数
                </a-button>
                
                <div v-if="mappingTestResults" class="result-box">
                    <h4>映射函数测试结果：</h4>
                    <pre>{{ JSON.stringify(mappingTestResults, null, 2) }}</pre>
                </div>
            </div>

            <div class="test-section">
                <h3>2. 创建问卷表单测试</h3>
                <p>模拟创建问卷时的类型选择和数据提交：</p>
                
                <a-form :model="createForm" layout="vertical">
                    <a-form-item label="问卷类型" name="type">
                        <a-select v-model:value="createForm.type" placeholder="请选择问卷类型">
                            <a-select-option value="调查问卷">调查问卷</a-select-option>
                            <a-select-option value="反馈问卷">反馈问卷</a-select-option>
                            <a-select-option value="评价问卷">评价问卷</a-select-option>
                            <a-select-option value="其他">其他</a-select-option>
                        </a-select>
                    </a-form-item>
                </a-form>
                
                <a-button type="primary" @click="testCreateForm" class="btn-test">
                    测试创建表单数据
                </a-button>
                
                <div v-if="createFormResult" class="result-box">
                    <h4>创建表单测试结果：</h4>
                    <pre>{{ JSON.stringify(createFormResult, null, 2) }}</pre>
                </div>
            </div>

            <div class="test-section">
                <h3>3. 编辑问卷表单测试</h3>
                <p>模拟编辑问卷时的数据加载和显示：</p>
                
                <a-form :model="editForm" layout="vertical">
                    <a-form-item label="问卷类型" name="type">
                        <a-select v-model:value="editForm.type" placeholder="请选择问卷类型">
                            <a-select-option value="调查问卷">调查问卷</a-select-option>
                            <a-select-option value="反馈问卷">反馈问卷</a-select-option>
                            <a-select-option value="评价问卷">评价问卷</a-select-option>
                            <a-select-option value="其他">其他</a-select-option>
                        </a-select>
                    </a-form-item>
                </a-form>
                
                <a-button type="primary" @click="testEditForm" class="btn-test">
                    测试编辑表单数据
                </a-button>
                
                <div v-if="editFormResult" class="result-box">
                    <h4>编辑表单测试结果：</h4>
                    <pre>{{ JSON.stringify(editFormResult, null, 2) }}</pre>
                </div>
            </div>

            <div class="test-section">
                <h3>4. 问卷管理列表测试</h3>
                <p>模拟问卷管理页面的类型显示：</p>
                
                <a-table :columns="tableColumns" :data-source="tableData" :pagination="false" size="small">
                    <template #bodyCell="{ column, record }">
                        <template v-if="column.key === 'questionnaire_type'">
                            {{ convertNumberToChineseType(record.questionnaire_type) }}
                        </template>
                    </template>
                </a-table>
                
                <a-button type="primary" @click="testTableDisplay" class="btn-test">
                    测试表格显示
                </a-button>
                
                <div v-if="tableTestResult" class="result-box">
                    <h4>表格显示测试结果：</h4>
                    <pre>{{ JSON.stringify(tableTestResult, null, 2) }}</pre>
                </div>
            </div>

            <div class="test-section">
                <h3>5. 完整数据流程测试</h3>
                <p>测试从创建到显示的完整数据流程：</p>
                
                <a-button type="primary" @click="testCompleteFlow" class="btn-test">
                    测试完整流程
                </a-button>
                
                <div v-if="completeFlowResult" class="result-box">
                    <h4>完整流程测试结果：</h4>
                    <pre>{{ JSON.stringify(completeFlowResult, null, 2) }}</pre>
                </div>
            </div>

            <div class="test-section">
                <h3>6. 错误处理测试</h3>
                <p>测试各种边界情况和错误处理：</p>
                
                <a-button type="primary" @click="testErrorHandling" class="btn-test">
                    测试错误处理
                </a-button>
                
                <div v-if="errorHandlingResult" class="result-box">
                    <h4>错误处理测试结果：</h4>
                    <pre>{{ JSON.stringify(errorHandlingResult, null, 2) }}</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive } = Vue;
        const { message } = antd;

        // 问卷类型映射工具（模拟从utils/questionnaireTypeMapping.js导入）
        const QUESTIONNAIRE_TYPE_MAP = {
            '调查问卷': 0,
            '反馈问卷': 1,
            '评价问卷': 2,
            '其他': 3
        };

        const QUESTIONNAIRE_TYPE_REVERSE_MAP = {
            0: '调查问卷',
            1: '反馈问卷',
            2: '评价问卷',
            3: '其他'
        };

        function convertChineseTypeToNumber(chineseType) {
            if (!chineseType) return 0;
            return QUESTIONNAIRE_TYPE_MAP[chineseType] !== undefined ? QUESTIONNAIRE_TYPE_MAP[chineseType] : 0;
        }

        function convertNumberToChineseType(numberType) {
            if (numberType === null || numberType === undefined) return '调查问卷';
            return QUESTIONNAIRE_TYPE_REVERSE_MAP[numberType] || '调查问卷';
        }

        function getAvailableQuestionnaireTypes() {
            return Object.keys(QUESTIONNAIRE_TYPE_MAP);
        }

        function isValidQuestionnaireType(chineseType) {
            return QUESTIONNAIRE_TYPE_MAP.hasOwnProperty(chineseType);
        }

        createApp({
            setup() {
                // 响应式数据
                const mappingTestResults = ref(null);
                const createFormResult = ref(null);
                const editFormResult = ref(null);
                const tableTestResult = ref(null);
                const completeFlowResult = ref(null);
                const errorHandlingResult = ref(null);

                const createForm = reactive({
                    type: '调查问卷'
                });

                const editForm = reactive({
                    type: '调查问卷'
                });

                // 表格列定义
                const tableColumns = [
                    {
                        title: '问卷标题',
                        dataIndex: 'title',
                        key: 'title'
                    },
                    {
                        title: '问卷类型',
                        dataIndex: 'questionnaire_type',
                        key: 'questionnaire_type'
                    },
                    {
                        title: '状态',
                        dataIndex: 'status',
                        key: 'status'
                    }
                ];

                // 模拟表格数据（包含数字类型的questionnaire_type）
                const tableData = ref([
                    {
                        title: '用户满意度调查',
                        questionnaire_type: 0,
                        status: '已发布'
                    },
                    {
                        title: '产品反馈收集',
                        questionnaire_type: 1,
                        status: '草稿'
                    },
                    {
                        title: '员工绩效评价',
                        questionnaire_type: 2,
                        status: '已发布'
                    },
                    {
                        title: '其他类型问卷',
                        questionnaire_type: 3,
                        status: '草稿'
                    }
                ]);

                // 测试方法
                const testMappingFunctions = () => {
                    const results = {
                        forwardMapping: {},
                        reverseMapping: {},
                        validation: {},
                        availableTypes: getAvailableQuestionnaireTypes()
                    };

                    // 测试正向映射（中文 -> 数字）
                    Object.keys(QUESTIONNAIRE_TYPE_MAP).forEach(chineseType => {
                        results.forwardMapping[chineseType] = convertChineseTypeToNumber(chineseType);
                    });

                    // 测试反向映射（数字 -> 中文）
                    Object.keys(QUESTIONNAIRE_TYPE_REVERSE_MAP).forEach(numberType => {
                        results.reverseMapping[numberType] = convertNumberToChineseType(parseInt(numberType));
                    });

                    // 测试验证函数
                    results.validation = {
                        '调查问卷': isValidQuestionnaireType('调查问卷'),
                        '反馈问卷': isValidQuestionnaireType('反馈问卷'),
                        '评价问卷': isValidQuestionnaireType('评价问卷'),
                        '其他': isValidQuestionnaireType('其他'),
                        '无效类型': isValidQuestionnaireType('无效类型')
                    };

                    mappingTestResults.value = results;
                    message.success('映射函数测试完成');
                };

                const testCreateForm = () => {
                    const result = {
                        selectedType: createForm.type,
                        convertedNumber: convertChineseTypeToNumber(createForm.type),
                        dataToSend: {
                            title: '测试问卷',
                            description: '这是一个测试问卷',
                            questionnaire_type: convertChineseTypeToNumber(createForm.type),
                            status: 1
                        }
                    };

                    createFormResult.value = result;
                    message.success('创建表单测试完成');
                };

                const testEditForm = () => {
                    const result = {
                        selectedType: editForm.type,
                        convertedNumber: convertChineseTypeToNumber(editForm.type),
                        dataToUpdate: {
                            title: '更新后的问卷',
                            description: '这是更新后的问卷',
                            questionnaire_type: convertChineseTypeToNumber(editForm.type),
                            status: 1
                        }
                    };

                    editFormResult.value = result;
                    message.success('编辑表单测试完成');
                };

                const testTableDisplay = () => {
                    const result = {
                        originalData: tableData.value,
                        displayMapping: tableData.value.map(item => ({
                            title: item.title,
                            originalType: item.questionnaire_type,
                            displayType: convertNumberToChineseType(item.questionnaire_type),
                            status: item.status
                        }))
                    };

                    tableTestResult.value = result;
                    message.success('表格显示测试完成');
                };

                const testCompleteFlow = () => {
                    const testCases = [
                        { chinese: '调查问卷', expected: 0 },
                        { chinese: '反馈问卷', expected: 1 },
                        { chinese: '评价问卷', expected: 2 },
                        { chinese: '其他', expected: 3 }
                    ];

                    const results = testCases.map(testCase => {
                        const number = convertChineseTypeToNumber(testCase.chinese);
                        const backToChinese = convertNumberToChineseType(number);
                        return {
                            original: testCase.chinese,
                            toNumber: number,
                            expectedNumber: testCase.expected,
                            backToChinese: backToChinese,
                            isCorrect: testCase.chinese === backToChinese && number === testCase.expected
                        };
                    });

                    completeFlowResult.value = {
                        testCases: results,
                        allCorrect: results.every(r => r.isCorrect)
                    };

                    message.success('完整流程测试完成');
                };

                const testErrorHandling = () => {
                    const errorTests = [
                        { input: null, description: 'null值' },
                        { input: undefined, description: 'undefined值' },
                        { input: '', description: '空字符串' },
                        { input: '无效类型', description: '无效的中文类型' },
                        { input: 999, description: '无效的数字类型' },
                        { input: -1, description: '负数' }
                    ];

                    const results = errorTests.map(test => {
                        const forwardResult = convertChineseTypeToNumber(test.input);
                        const reverseResult = convertNumberToChineseType(test.input);
                        return {
                            input: test.input,
                            description: test.description,
                            forwardResult: forwardResult,
                            reverseResult: reverseResult,
                            forwardSafe: typeof forwardResult === 'number' && forwardResult >= 0,
                            reverseSafe: typeof reverseResult === 'string' && reverseResult.length > 0
                        };
                    });

                    errorHandlingResult.value = {
                        errorTests: results,
                        allSafe: results.every(r => r.forwardSafe && r.reverseSafe)
                    };

                    message.success('错误处理测试完成');
                };

                return {
                    // 数据
                    mappingTestResults,
                    createFormResult,
                    editFormResult,
                    tableTestResult,
                    completeFlowResult,
                    errorHandlingResult,
                    createForm,
                    editForm,
                    tableColumns,
                    tableData,

                    // 方法
                    testMappingFunctions,
                    testCreateForm,
                    testEditForm,
                    testTableDisplay,
                    testCompleteFlow,
                    testErrorHandling,
                    convertNumberToChineseType
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
